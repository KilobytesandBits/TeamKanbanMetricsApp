<!DOCTYPE html>
<html>
<head>
    <title>TeamKanbanMetricsApp</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var types=Ext.data.Types;Ext.define("ThroughputDataModel",{extend:"Ext.data.Model",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"AcceptedDate",mapping:"AcceptedDate",type:types.DATE},{name:"InProgressDate",mapping:"InProgressDate",type:types.DATE},{name:"Tags",mapping:"Tags",type:types.STRING},{name:"Owner",mapping:"Owner",type:types.OBJECT},{name:"CycleTime",mapping:"CycleTime",type:types.FLOAT},{name:"CycleTimeCategory",mapping:"CycleTimeCategory",type:types.STRING}]}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"throughputCycleTimeReport",id:"throughputCycleTimeReport",items:[{xtype:"container",itemId:"throughputContainer",id:"throughputContainer",title:"Throughput"},{xtype:"container",itemId:"cycleTimeContainer",id:"cycleTimeContainer",title:"Cycle-Time"}],layout:{type:"hbox",align:"stretch",padding:10}},{xtype:"container",itemId:"WipLimitSLAReport",id:"WipLimitSLAReport",items:[{xtype:"container",itemId:"wipContainer",id:"wipContainer",title:"WIP Limit"},{xtype:"container",itemId:"slaContainer",id:"slaContainer",title:"SLA Counter"}],layout:{type:"hbox",align:"stretch",padding:10}}],layout:{type:"vbox",align:"stretch",padding:10},cycleTimeCategoryNames:["0-5 days","6-10 days","11-15 days","16-20 days","21-25 days","26-30 days","31+ days"],cycleTimeDistRange:5,launch:function(){this.activeViews=["throughputCycleTimeReport","WipLimitSLAReport"],this._init(),this.currThroughputMessage="<div>The Throughput for current period (between Start Date & End Date) is : <b> 10 </b></div>",this.prevThroughputMessage="<div>The Throughput for Previous period (between Start Date & End Date) is : <b> 10 </b></div>",this._determineDateRangeForThroughput(),this._createDataStoreForThroughput()},_init:function(){var that=this;this.dynamicItems===void 0&&(this.dynamicItems={}),Ext.Array.each(this.activeViews,function(viewName){if(that.dynamicItems[viewName]===void 0)that.dynamicItems[viewName]={};else{var item;for(item in that.dynamicItems[viewName])that.dynamicItems[viewName][item].destroy()}})},_determineDateRangeForThroughput:function(){this.curr_End_Date=new Date;var tmp_Curr_Date=new Date;tmp_Curr_Date.setDate(tmp_Curr_Date.getDate()-30),this.curr_Start_Date=tmp_Curr_Date,this.currStartRallyDateFilter=this.curr_Start_Date.getFullYear()+"-"+(parseInt(this.curr_Start_Date.getMonth(),10)+1)+"-"+this.curr_Start_Date.getDate(),this.currEndRallyDateFilter=this.curr_End_Date.getFullYear()+"-"+(parseInt(this.curr_End_Date.getMonth(),10)+1)+"-"+this.curr_End_Date.getDate();var tmp_Prev_Date=new Date;tmp_Prev_Date.setDate(tmp_Prev_Date.getDate()-60),this.prev_Start_Date=tmp_Prev_Date,this.prev_End_Date=Ext.Date.add(this.curr_Start_Date,Ext.Date.DAY,-1),this.prevStartRallyDateFilter=this.prev_Start_Date.getFullYear()+"-"+(parseInt(this.prev_Start_Date.getMonth(),10)+1)+"-"+this.prev_Start_Date.getDate(),this.prevEndRallyDateFilter=this.prev_End_Date.getFullYear()+"-"+(parseInt(this.prev_End_Date.getMonth(),10)+1)+"-"+this.prev_End_Date.getDate(),this.past_Date_SixMonth=Ext.Date.add(this.curr_Start_Date,Ext.Date.MONTH,-5),this.pastDateSixMonthFilter=this.past_Date_SixMonth.getFullYear()+"-"+(parseInt(this.past_Date_SixMonth.getMonth(),10)+1)+"-"+this.past_Date_SixMonth.getDate()},_createDataStoreForThroughput:function(){this.filter=Ext.create("Rally.data.QueryFilter",{property:"AcceptedDate",operator:">=",value:this.pastDateSixMonthFilter}).and(Ext.create("Rally.data.QueryFilter",{property:"AcceptedDate",operator:"<=",value:this.currEndRallyDateFilter})).and(Ext.create("Rally.data.QueryFilter",{property:"c_KanbanState",operator:"=",value:"Accepted"})),this.fetchDataColumns=["FormattedID","Name","AcceptedDate","InProgressDate","Tags","Owner","c_KanbanState"],this.contextConfig={workspace:this.getContext().getWorkspace()._Ref,project:this.getContext().getProject()._ref,projectScopeUp:!1,projectScopeDown:!0,limit:"infinity"},this.sorterConfig=[{property:"AcceptedDate",direction:"ASC"},{property:"FormattedID",direction:"ASC"}],this._createUserStoryDataStore()},_createUserStoryDataStore:function(){var myUserStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:this.fetchDataColumns,autoLoad:!0,context:this.contextConfig,filters:this.filter,sorters:this.sorterConfig,listeners:{load:function(store,data,success){this.currUserStoriesColl=[],this.prevUserStoriesColl=[],this.pastRangeUserStoriesColl=[];var that=this;Ext.Array.each(data,function(userStory){userStory&&userStory.get("AcceptedDate")&&(userStory.get("AcceptedDate")>=that.curr_Start_Date&&that.currUserStoriesColl.push(that._createThroghputData(userStory)),userStory.get("AcceptedDate")<that.curr_Start_Date&&userStory.get("AcceptedDate")>=that.prev_Start_Date&&that.prevUserStoriesColl.push(that._createThroghputData(userStory)),that.pastRangeUserStoriesColl.push(that._createThroghputData(userStory)))}),this._createDefectStore()},scope:this}})},_createThroghputData:function(rallyObject){var cycleTime=0,cycleTimeCat="N/A";rallyObject.get("AcceptedDate")&&rallyObject.get("InProgressDate")&&(cycleTime=Rally.util.DateTime.getDifference(rallyObject.get("AcceptedDate"),rallyObject.get("InProgressDate"),"day"));for(var i=0;this.cycleTimeCategoryNames.length>i;i++){var lowerRange=i*this.cycleTimeDistRange,upperRange=lowerRange+5;(cycleTime>lowerRange&&upperRange>=cycleTime||30===lowerRange&&cycleTime>lowerRange)&&(cycleTimeCat=this.cycleTimeCategoryNames[i])}var data=Ext.create("ThroughputDataModel",{FormattedID:rallyObject.get("FormattedID"),Name:rallyObject.get("Name"),AcceptedDate:rallyObject.get("AcceptedDate"),InProgressDate:rallyObject.get("InProgressDate"),Tags:rallyObject.get("Tags"),Owner:rallyObject.get("Owner"),CycleTime:cycleTime,CycleTimeCategory:cycleTimeCat});return data},_createDefectStore:function(){var that=this,myDefectStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:this.fetchDataColumns,autoLoad:!0,context:this.contextConfig,filters:this.filter,sorters:this.sorterConfig,listeners:{load:function(store,data,success){Ext.Array.each(data,function(defect){defect&&defect.get("AcceptedDate")&&(defect.get("AcceptedDate")>=that.curr_Start_Date&&that._insertRecordInOrder(that.currUserStoriesColl,that._createThroghputData(defect)),defect.get("AcceptedDate")<that.curr_Start_Date&&defect.get("AcceptedDate")>=that.prev_Start_Date&&that._insertRecordInOrder(that.prevUserStoriesColl,that._createThroghputData(defect)),that._insertRecordInOrder(that.pastRangeUserStoriesColl,that._createThroghputData(defect)))}),this.currThroughputValue=this.currUserStoriesColl.length,this.prevThroughputValue=this.prevUserStoriesColl.length,this.currThroughputDataStore=Ext.create("Rally.data.custom.Store",{data:this.currUserStoriesColl,pageSize:100}),this.prevThroughputDataStore=Ext.create("Rally.data.custom.Store",{data:this.prevUserStoriesColl,pageSize:100}),this.pastRangeThroughputDataStore=Ext.create("Rally.data.custom.Store",{model:"ThroughputDataModel",data:this.pastRangeUserStoriesColl,pageSize:100}),this._createThroghputMessagePanel()},scope:this}})},_insertRecordInOrder:function(dataColl,record){var closestRecord=record,recordDate=record.get("AcceptedDate");Ext.Array.each(dataColl,function(data){var dataDate=data.get("AcceptedDate");dataDate&&recordDate&&dataDate.getMonth()===recordDate.getMonth()&&recordDate>=dataDate&&(closestRecord=data)});var dataIndex=dataColl.indexOf(closestRecord);-1!=dataIndex?dataColl.splice(dataIndex,0,record):dataColl.push(record)},_createThroghputMessagePanel:function(){this._configureCycleTimeMetricsContainer("panel1","CycleTime","cycleTimeContainer","throughputCycleTimeReport",!0),this._configureThroughputMetricsContainer("panel2","Throughput","throughputContainer","throughputCycleTimeReport",!0)},_createThroughputDataGrid:function(title,dataStore,gridId){console.log("Data Grid creation................");var grid=Ext.create("Rally.ui.grid.Grid",{id:gridId,title:title,store:dataStore,bodyBorder:!0,columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",width:100},{text:"Name",dataIndex:"Name",width:500},{text:"Accepted Date",dataIndex:"AcceptedDate",width:200,emptyCellText:"No Date",renderer:function(value){return value?value.getFullYear()+"-"+(parseInt(value.getMonth(),10)+1)+"-"+value.getDate():void 0}},{text:"InProgress Date",dataIndex:"InProgressDate",width:200,emptyCellText:"No Date",renderer:function(value){return value?value.getFullYear()+"-"+(parseInt(value.getMonth(),10)+1)+"-"+value.getDate():void 0}},{text:"Owner",dataIndex:"Owner",flex:1,emptyCellText:"No Owner",renderer:function(value){return value&&value._refObjectName?value._refObjectName:void 0}},{text:"Tags",dataIndex:"Tags",flex:1,emptyCellText:"No Tags",renderer:function(value){return value&&value.Name?value.Name:void 0}},{text:"CycleTime",dataIndex:"CycleTime",flex:1},{text:"CycleTime Category",dataIndex:"CycleTimeCategory",flex:1}]});return grid},_createMetricsContainer:function(containerId,currThroughputMessage,prevThroughputMessage){console.log("creating metrics container.......");var myContainer=Ext.create("Ext.container.Container",{id:containerId,layout:{type:"vbox",align:"stretch",padding:15},renderTo:Ext.getBody(),border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},items:[{xtype:"label",html:currThroughputMessage},{xtype:"label",html:prevThroughputMessage}]});return myContainer},_configureMetricsContainer:function(panelId,titleName,throughtputContainer,containerId,reportId,pastRangeDataGrid,hasGraph){console.log("start configuring the metrics container.......... for "+containerId);var widthValue=hasGraph?850:600;this.dynamicItems[reportId][panelId]!==void 0&&this.dynamicItems[reportId][panelId].destroy(),console.log("creating info panel to load message container and grid. for "+containerId);var infoPanel=Ext.create("Ext.form.Panel",{id:panelId,title:titleName,renderTo:Ext.getBody(),width:widthValue,height:300,layout:{type:"vbox",align:"stretch",padding:15},items:[throughtputContainer,pastRangeDataGrid]});this.dynamicItems[reportId][panelId]=Ext.getCmp(containerId).add(infoPanel)},_configureCycleTimeMetricsContainer:function(panelId,titleName,containerId,reportId,hasGraph){this.currCycleTimeMessage="<div>The Avg. CycleTime for current period (between "+this.currStartRallyDateFilter+" & "+this.currEndRallyDateFilter+") is : <b> TBI </b></div>",this.prevCycleTimeMessage="<div>The Avg. CycleTime for previous period (between "+this.prevStartRallyDateFilter+" & "+this.prevEndRallyDateFilter+") is : <b> TBI </b></div>";var cycleTimeContainer=this._createMetricsContainer("Cycle Time",this.currCycleTimeMessage,this.prevCycleTimeMessage);this._processCycleTimeDataForGraph();var cycleTimeGraphContainer=this.cycleTimePieOrBarGraphChart,widthValue=600;this.dynamicItems[reportId][panelId]!==void 0&&this.dynamicItems[reportId][panelId].destroy();var infoPanel=Ext.create("Ext.form.Panel",{id:panelId,title:titleName,renderTo:Ext.getBody(),width:widthValue,height:550,layout:{type:"vbox",align:"stretch",padding:15},items:[cycleTimeContainer,cycleTimeGraphContainer]});this.dynamicItems[reportId][panelId]=Ext.getCmp(containerId).add(infoPanel)},_processCycleTimeDataForGraph:function(){var that=this;this.pieData={totalCount:0,months:{},monthCount:0,categories:[]},Ext.Array.each(this.pastRangeUserStoriesColl,function(record){that._buildCycleTimeChartData(record)}),this._initAndDrawCycleTimeCharts(this.pieData)},_buildCycleTimeChartData:function(record){var pieData=this.pieData,recAcceptedDate=record.get("AcceptedDate"),recCycleTime=record.get("CycleTime"),recMonthNameCat=Ext.Date.getShortMonthName(recAcceptedDate.getMonth());pieData.months[recMonthNameCat]===void 0&&(pieData.months[recMonthNameCat]={count:0,avgCycleTime:0,totalCycleTime:0,cycletimes:[]},pieData.categories.push(recMonthNameCat),pieData.monthCount++),pieData.months[recMonthNameCat].cycletimes.push(recCycleTime),pieData.months[recMonthNameCat].count++,pieData.months[recMonthNameCat].totalCycleTime=pieData.months[recMonthNameCat].totalCycleTime+recCycleTime,pieData.months[recMonthNameCat].avgCycleTime=Math.ceil(pieData.months[recMonthNameCat].totalCycleTime/pieData.months[recMonthNameCat].count),pieData.totalCount++,this.pieData=pieData},_initAndDrawCycleTimeCharts:function(pieData){var cycleTimeData=[],sizeData=[],categories=[];if(0!==pieData.totalCount){for(month in pieData.months)cycleTimeData.push([month,pieData.months[month].avgCycleTime]),sizeData.push([month,pieData.months[month].count]),categories.push(month);var cycleTimeHorBarGraph=this._drawCycleTimeHorizontalBarChart(categories,cycleTimeData);this._createCycleTimeBarGraphContainer(cycleTimeHorBarGraph)}},_createCycleTimeBarGraphContainer:function(barGraph){this.cycleTimePieOrBarGraphChart=Ext.create("Ext.container.Container",{itemId:"defaultPieChartContainer",id:"defaultPieChartContainer",layout:{type:"hbox",align:"stretch",padding:10},renderTo:Ext.getBody(),border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},items:[barGraph]})},_createCycleTimePieContainer:function(cycleTimePie,bySizePie){this.cycleTimePieOrBarGraphChart=Ext.create("Ext.container.Container",{itemId:"defaultPieChartContainer",id:"defaultPieChartContainer",layout:{type:"hbox",align:"stretch",padding:10},renderTo:Ext.getBody(),border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},items:[cycleTimePie,bySizePie]})},_drawCycleTimeHorizontalBarChart:function(categories,leadTimeData){var conf={id:"horizontalBars",series:[{name:"Cycle Time",data:leadTimeData}],chartType:"bar",chartTitle:"UserStory Cycle Time",xAxisCategories:categories,xAxisTitle:"Months",yAxisTitle:"Days",_formatLabelsAppendix:" days",plotOptions:{bar:{dataLabels:{enabled:this.getSetting("showDataLabels")}}}};return this._drawCycleTimeBarChart(conf)},_drawCycleTimeBarChart:function(conf){var chart={xtype:"rallychart",id:conf.id,height:400,width:550,chartData:{series:conf.series},chartColors:["#FF3333","#00CC00"],chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:conf.chartType},legend:{align:"right",verticalAlign:"top",x:0,y:100,layout:"vertical"},title:{text:conf.chartTitle},tooltip:{_formatLabels:function(){return"<b>"+this.series.name+"</b><br/>"+this.x+": "+this.y+conf._formatLabelsAppendix}},yAxis:[{title:{text:conf.yAxisTitle}}],xAxis:[{title:{text:conf.xAxisTitle},categories:conf.xAxisCategories}],plotOptions:conf.plotOptions}};return chart},_drawPie:function(id,name,text,data,extraData){var chart={xtype:"rallychart",id:id,height:400,width:400,style:{"float":"left"},chartData:{series:[{type:"pie",name:name,data:data}]},chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},xAxis:{},title:{text:text},tooltip:{pointFormat:"{series.name}: <b>{point.y}</b>",percentageDecimals:1,_formatLabels:function(){return _formatLabels(id,this,extraData)}},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,color:"#000000",connectorColor:"#000000",_formatLabels:function(){return Rally.getApp()._formatLabels(id,this,extraData)}}}}}};return chart},_formatLabels:function(id,that,extraData){switch(id){case"cycleTimePie":return"<b>"+that.point.name+"</b><br/>AVG Cycle Time: "+that.y;case"bySizePie":return"<b>"+that.point.name+"</b><br/>Count: "+that.y}},_configureThroughputMetricsContainer:function(panelId,titleName,containerId,reportId,hasGraph){this.currThroughputMessage="<div>The Throughput for current period (between "+this.currStartRallyDateFilter+" & "+this.currEndRallyDateFilter+") is : <b>"+this.currThroughputValue+"</b></div>",this.prevThroughputMessage="<div>The Throughput for previous period (between "+this.prevStartRallyDateFilter+" & "+this.prevEndRallyDateFilter+") is : <b>"+this.prevThroughputValue+"</b></div>";var throughtputContainer=this._createMetricsContainer("throughput",this.currThroughputMessage,this.prevThroughputMessage);this._processThroughputDataForGraph();var throughtputGraphContainer=this._createThroughputGraphContainer(this.throughputChart),pastRangeThroghtputGridTitle="View Throughput Data",pastRangeThroughputDataGrid=this._createThroughputDataGrid(pastRangeThroghtputGridTitle,this.pastRangeThroughputDataStore,"throughputGrid"),widthValue=hasGraph?850:600;this.dynamicItems[reportId][panelId]!==void 0&&this.dynamicItems[reportId][panelId].destroy();var infoPanel=Ext.create("Ext.form.Panel",{id:panelId,title:titleName,renderTo:Ext.getBody(),width:widthValue,height:550,layout:{type:"vbox",align:"stretch",padding:15},items:[throughtputContainer,throughtputGraphContainer]});this.dynamicItems[reportId][panelId]=Ext.getCmp(containerId).add(infoPanel)},_createThroughputGraphContainer:function(throughputChart){var graphContainer=Ext.create("Ext.container.Container",{itemId:"defaultChartContainer",id:"defaultChartContainer",layout:{type:"vbox",align:"stretch",padding:10},renderTo:Ext.getBody(),border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},items:[throughputChart]});return graphContainer},_processThroughputDataForGraph:function(){var that=this;this.groupedSeries=[],Ext.Array.each(that.cycleTimeCategoryNames,function(catName){that.groupedSeries.push({name:catName,data:[],stack:"qSizes"})}),that.groupedSeries.push({name:"N/A",data:[],stack:"qSizes"}),this.chartData={totalCount:0,months:{},monthCount:0,categories:[]},Ext.Array.each(this.pastRangeUserStoriesColl,function(record){that._buildThroughputChartData(record)}),this._initAndDrawThroughputCharts(this.chartData)},_buildThroughputChartData:function(record){var chartData=this.chartData,recAcceptedDate=record.get("AcceptedDate"),recCycleTimeCat=record.get("CycleTimeCategory"),recMonthNameCat=Ext.Date.getShortMonthName(recAcceptedDate.getMonth());if(console.log("spite out accepted Month Number: ",recAcceptedDate.getMonth()),chartData.months[recMonthNameCat]===void 0){chartData.months[recMonthNameCat]={count:0,monthNum:0,cycletimes:{},userStories:[]},chartData.categories.push(recMonthNameCat);for(var i=0;this.groupedSeries.length>i;++i)this.groupedSeries[i].data.push(0);chartData.monthCount++}chartData.months[recMonthNameCat].userStories.push(record),chartData.months[recMonthNameCat].cycletimes[recCycleTimeCat]===void 0&&(chartData.months[recMonthNameCat].cycletimes[recCycleTimeCat]=0),chartData.months[recMonthNameCat].cycletimes[recCycleTimeCat]++,chartData.months[recMonthNameCat].count++,chartData.totalCount++;for(var s=0;this.groupedSeries.length>s;++s)recCycleTimeCat===this.groupedSeries[s].name&&(this.groupedSeries[s].data[chartData.monthCount-1]=chartData.months[recMonthNameCat].cycletimes[recCycleTimeCat]);this.chartData=chartData},_initAndDrawThroughputCharts:function(inputData){if(0!==inputData.totalCount){var throughput=[],i,qCount=0,currTotalCount=0,avgTotals=[],monthAVGs=[];for(i in inputData.months)throughput.push(inputData.months[i].count),currTotalCount+=inputData.months[i].count,qCount++,avgTotals.push(Math.round(currTotalCount/qCount,2));for(i=0;inputData.monthCount>i;++i)monthAVGs.push(Math.round(inputData.totalCount/inputData.monthCount,2));this.groupedSeries.unshift({name:"Throughput",data:throughput}),this.groupedSeries.push({type:"spline",name:"Moving Average",data:avgTotals,color:"blue",marker:{lineWidth:1,fillColor:"red"}}),this.groupedSeries.push({type:"spline",name:"Average / Month",data:monthAVGs,color:"purple",marker:{lineWidth:1,fillColor:"red"}}),this.groupedSeries.push({name:"Total UserStories: "+inputData.totalCount,color:"#fff",stack:"blank"}),this._drawThroughputVerticalBarChart(inputData.categories,this.groupedSeries)}},_drawThroughputVerticalBarChart:function(categories,data){var conf={id:"verticalBars",targetContainer:"#defaultChartContainer",series:data,chartType:"column",chartTitle:"Throughput by Months",xAxisCategories:categories,xAxisTitle:"Months",yAxisTitle:"Count"};this._drawThroughputBarChart(conf)},_drawThroughputBarChart:function(conf){this.throughputChart=Ext.create("Rally.ui.chart.Chart",{id:conf.id,height:400,chartData:{series:conf.series},chartConfig:{plotOptions:{column:{stacking:"normal",cursor:"pointer",point:{events:{click:function(){}}}}},chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:conf.chartType},legend:{align:"right",verticalAlign:"top",x:0,y:100,layout:"vertical"},title:{text:conf.chartTitle},tooltip:{formatter:function(){return"<b>"+this.series.name+" | "+this.x+"</b><br/>"+"<b>"+this.y+"</b> User Stories<br/><i>(Click to view User Stories)</i>"}},yAxis:[{title:{text:conf.yAxisTitle}}],xAxis:[{title:{text:conf.xAxisTitle},categories:conf.xAxisCategories}]}})}});

            Rally.launchApp('CustomApp', {
                name:"TeamKanbanMetricsApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
